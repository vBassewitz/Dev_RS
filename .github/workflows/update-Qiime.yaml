name: Check for new QIIME2 Release

on:
  schedule:
    # At the end of every day
    - cron: "0 0 * * *"

jobs:
  Create-PR-for-new-qiime2-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Install mamba
        uses: conda-incubator/setup-miniconda@v2
        with:
          mamba-version: "*"
          channels: bioconda,conda-forge,defaults
          channel-priority: true

      - name: Get latest qiime2 release
        shell: bash -l {0}
        run: |
          echo "LATEST_QIIME2=$(mamba search -f qiime2 -c qiime2 | tail -n1 | awk '{print $2}')" >> $GITHUB_ENV
          echo "Latest qiime2 release: $(mamba search -f qiime2 -c qiime2 | tail -n1 | awk '{print $2}')"

      - name: Get qiime2 release used in RiboSnake
        run: |
          echo "CURRENT_QIIME2=$(cat workflow/envs/qiime-only-env.yaml | grep qiime2 | awk -F "=" '{print $2}')" >> $GITHUB_ENV
          echo "Current qiime2 release: $(cat workflow/envs/qiime-only-env.yaml | grep qiime2 | awk -F "=" '{print $2}')"

      - name: Update qiime2 release used in RiboSnake
        if: ${{ env.LATEST_QIIME2 != env.CURRENT_QIIME2 }}
        run: |
          sed -i 's/${{ env.CURRENT_QIIME2 }}/${{ env.LATEST_QIIME2 }}/' workflow/envs/qiime-only-env.yaml

      - name: Create Pull Request
        if: ${{ env.LATEST_QIIME2 != env.CURRENT_QIIME2 }}
        id: cpr
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          committer: GitHub <noreply@github.com>
          commit-message: Update qiime2 to ${{ env.LATEST_QIIME2 }}
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          branch: qiime2-update-to-${{ env.LATEST_QIIME2 }}
          delete-branch: true
          title: "build: update qiime2 to ${{ env.LATEST_QIIME2 }}"
          body: |
            Hey there, a new release of QIIME2 is available: [${{ env.LATEST_QIIME2 }}](https://github.com/qiime2/qiime2/releases/tag/${{ env.LATEST_QIIME2 }})

            Auto-generated by [create-pull-request][1]

            [1]: https://github.com/peter-evans/create-pull-request
          labels: |
            automated pr

      - name: Check outputs
        run: |
          echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"